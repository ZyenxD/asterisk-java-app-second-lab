/*
 * This Java source file was generated by the Gradle 'init' task.
 */

import org.asteriskjava.fastagi.*;

import java.io.IOException;
import java.lang.Math;
import java.util.Random;
import java.util.concurrent.TimeUnit;

public class HelloAgiScript extends BaseAgiScript{

    static public String THANKS_AUDIO_FILE_ROUTE = "/usr/share/asterisk/sounds/en/auth-thankyou";
    static public String HELLO_AUDIO_FILE_ROUTE = "/usr/share/asterisk/sounds/custom/google_hello";
    static public String EXMAPLE_AUDIO_FILE_ROUTE = "/usr/share/asterisk/sounds/custom/google_example";
    static public String ANOTHER_AUDIO_FILE_ROUTE = "/usr/share/asterisk/sounds/custom/google_another";
    static public String BEEP_FILE_ROUTE = "/usr/share/asterisk/sounds/en/beep";
    static public String SOX_COMMAND = "/usr/bin/sox";
    static public String PERMISSION_COMMAND = "sudo chmod";
    static public String GOOGLE_ASSISTANT_COMMAND = "googlesamples-assistant-pushtotalk";
    static public String GOOGLE_ASSISTANT_JSON_FILE_ROUTE = "/home/pi/.config/google-oauthlib-tool/credentials.json";

    public static void main(String[] args) {
        
    }

    @Override
    public void service(AgiRequest request, AgiChannel channel) throws AgiException {
        Pipeline loopPipeline = new Pipeline();
        Pipeline startPipeline = new Pipeline();

		Random fileNumber = new Random();
        String fileName = "/tmp/google_audio"+fileNumber.nextInt();
        String googleCommand = String.format("%s --credentials %s -i %s_in.wav -o %s_out.wav",GOOGLE_ASSISTANT_COMMAND,GOOGLE_ASSISTANT_JSON_FILE_ROUTE,fileName,fileName);
        String soxConvertInputCommand = String.format("%s filename.wav -r 16000 filename_in.wav",SOX_COMMAND);
        String soxConvertOutputCommand = String.format("%s filename_out.wav -t raw -r 8k -e signed-integer -b 16 -c 1 filename_8k.sln",SOX_COMMAND);
        String chmodCommand = String.format("%s 777 %s.wav",PERMISSION_COMMAND,fileName);

		startPipeline.addCommand(new StreamPipe("PLAY_WELCOME_FILE"),HELLO_AUDIO_FILE_ROUTE);
        startPipeline.addCommand(new StreamPipe("PLAY_EXAMPLE_FILE"),EXMAPLE_AUDIO_FILE_ROUTE);

        loopPipeline.addCommand( new StreamPipe("PLAY_BEEP_FILE"),BEEP_FILE_ROUTE);
        loopPipeline.addCommand( new RecordPipe("RECORD_INPUT_FILE"),fileName);
		loopPipeline.addCommand( new StreamPipe("PLAY_THANKS_FILE"),THANKS_AUDIO_FILE_ROUTE);
		loopPipeline.addCommand( new ProcessPipe("GRANT_PERMISSION_TO_MODIFY_INPUT"),chmodCommand);
		loopPipeline.addCommand( new ProcessPipe("CONVERT_INPUT_AUDIO_FILE"),soxConvertInputCommand.replace("filename", fileName));
		loopPipeline.addCommand( new ProcessPipe("RUN_GOOGLE_ASSISTANT"),googleCommand);
		loopPipeline.addCommand( new ProcessPipe("GRANT_PERMISSION_TO_MODIFY_OUTPUT"),chmodCommand.replace(fileName+".wav",fileName+"_out.wav"));
		loopPipeline.addCommand( new ProcessPipe("CONVERT_OUTPUT_AUDIO_FILE"),soxConvertOutputCommand.replace("filename", fileName));
		loopPipeline.addCommand( new StreamPipe("PLAY_GOOGLE_OUTPUT"),fileName+"_8k");
        loopPipeline.addCommand( new StreamPipe("PLAY_ANOTHER_FILE"),ANOTHER_AUDIO_FILE_ROUTE);
        

        boolean started = true;
        

        //introduction
        startPipeline.execute();

        while(started){
          loopPipeline.execute();
        }
        
        
    }



}
